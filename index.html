<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>النسخة الذكية Web OCR</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      direction: rtl;
    }
    input[type="file"] {
      margin: 20px 0;
    }
    #result {
      margin-top: 20px;
      white-space: pre-wrap;
      background-color: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      font-size: 16px;
      text-align: right;
    }
  </style>
</head>
<body>
  <h1>📷 النسخة الذكية لتحليل نتائج الألعاب - Web OCR</h1>
  <p>ارفع صورة تحتوي على نتائج من لعبة في Linebet أو 1xBet</p>
  <input type="file" accept="image/*" onchange="handleImage(event)">
  <div id="result">⚙️ في انتظار صورة لتحليلها...</div>

  <!-- مكتبة OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

  <script>
    const resultDiv = document.getElementById('result');

    function handleImage(event) {
      const file = event.target.files[0];
      if (!file) return;

      resultDiv.textContent = '📤 جارٍ تحليل الصورة...';

      Tesseract.recognize(file, 'eng', {
        logger: m => console.log(m)
      }).then(({ data: { text } }) => {
        const cleanedText = text.trim();
        resultDiv.textContent = '🧠 النص المُستخرج:\n' + cleanedText;

        // تحليل ذكي مبدئي محلي (بسيط)
        const aiResultDiv = document.createElement('div');
        aiResultDiv.style.marginTop = '20px';
        aiResultDiv.style.color = '#006600';

        if (cleanedText.includes('win') || cleanedText.includes('Victory') || cleanedText.includes('x2')) {
          aiResultDiv.textContent = '✅ تحليل AI: احتمال كبير أن النتيجة كانت فوزًا.';
        } else if (cleanedText.includes('lose') || cleanedText.includes('fail') || cleanedText.includes('x0')) {
          aiResultDiv.textContent = '❌ تحليل AI: هذه النتيجة تشير إلى خسارة.';
        } else {
          aiResultDiv.textContent = '🤖 تحليل AI: لم يتم التعرّف بدقة على النتيجة.';
        }

        resultDiv.appendChild(aiResultDiv);

        // إرسال إلى Cloud AI
        syncToCloud(cleanedText).then(cloudResponse => {
          if (cloudResponse && cloudResponse.suggestion) {
            const cloudDiv = document.createElement('div');
            cloudDiv.style.marginTop = '15px';
            cloudDiv.style.color = '#000066';
            cloudDiv.textContent = '🌐 توصية سحابية: ' + cloudResponse.suggestion;
            resultDiv.appendChild(cloudDiv);
          }
        });

      }).catch(err => {
        resultDiv.textContent = '❌ فشل في قراءة الصورة:\n' + err.message;
      });
    }

    // Cloud AI المدمج داخل الصفحة
    function getDeviceId() {
      let id = localStorage.getItem('cloud_device_id');
      if (!id) {
        id = 'device-' + Math.random().toString(36).substring(2, 10);
        localStorage.setItem('cloud_device_id', id);
      }
      return id;
    }

    async function syncToCloud(ocrText) {
      try {
        const payload = {
          text: ocrText,
          deviceId: getDeviceId(),
          timestamp: new Date().toISOString()
        };

        const res = await fetch('https://api.cloud-ai-linebet.net/sync', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const json = await res.json();
        return json;
      } catch (err) {
        console.warn("⛔ فشل الاتصال بالسيرفر السحابي:", err.message);
        return { status: "offline", suggestion: "تعذّر الاتصال بالسحابة." };
      }
    }
  </script>
</body>
</html>
