<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>النسخة المتقدمة Web OCR</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      direction: rtl;
    }
    input[type="file"] {
      margin: 20px 0;
    }
    #result {
      margin-top: 20px;
      white-space: pre-wrap;
      background-color: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      font-size: 16px;
      text-align: right;
    }
    #history {
      margin-top: 30px;
      background: #e8e8e8;
      padding: 10px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h1>🧠 النسخة المتقدمة - Web OCR</h1>
  <p>ارفع صورة من اللعبة لبدء التحليل الذكي</p>
  <input type="file" accept="image/*" onchange="handleImage(event)">
  <div id="result">📷 في انتظار صورة...</div>
  <div id="history"><strong>🕓 آخر 5 تحليلات:</strong><ul id="historyList"></ul></div>

  <!-- مكتبة OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

  <!-- التوصيات الصوتية -->
  <script>
    function speak(text) {
      if ('speechSynthesis' in window) {
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'ar-SA';
        window.speechSynthesis.speak(msg);
      }
    }
  </script>

  <script>
    const resultDiv = document.getElementById('result');
    const historyList = document.getElementById('historyList');

    function handleImage(event) {
      const file = event.target.files[0];
      if (!file) return;

      resultDiv.textContent = '⏳ جارٍ معالجة الصورة...';

      Tesseract.recognize(file, 'eng', {
        logger: m => console.log(m)
      }).then(({ data: { text } }) => {
        const cleanedText = text.trim();
        const now = new Date().toLocaleString('ar-EG');
        let analysis = '';
        let voiceMessage = '';

        // تحليل ذكي
        if (cleanedText.includes('win') || cleanedText.includes('Victory') || cleanedText.includes('x2')) {
          analysis = '✅ فوز متوقّع.';
          voiceMessage = 'تم التعرف على فوز.';
        } else if (cleanedText.includes('lose') || cleanedText.includes('fail') || cleanedText.includes('x0')) {
          analysis = '❌ خسارة متوقّعة.';
          voiceMessage = 'تم التعرف على خسارة.';
        } else {
          analysis = '🤖 لم يتم التعرف على نتيجة واضحة.';
          voiceMessage = 'لم يتم تحديد النتيجة بدقة.';
        }

        const fullResult = `📄 النص المُستخرج:\n${cleanedText}\n\n🧠 التحليل:\n${analysis}\n📅 الوقت: ${now}`;
        resultDiv.textContent = fullResult;
        speak(voiceMessage);

        // حفظ النتيجة محلياً
        const history = JSON.parse(localStorage.getItem('ocr_history') || '[]');
        history.unshift({ time: now, result: analysis });
        if (history.length > 5) history.pop();
        localStorage.setItem('ocr_history', JSON.stringify(history));

        // تحديث التاريخ
        updateHistoryList();

      }).catch(err => {
        resultDiv.textContent = '❌ فشل في التحليل:\n' + err.message;
        speak('فشل في قراءة الصورة.');
      });
    }

    function updateHistoryList() {
      const history = JSON.parse(localStorage.getItem('ocr_history') || '[]');
      historyList.innerHTML = '';
      history.forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.time} - ${item.result}`;
        historyList.appendChild(li);
      });
    }

    // عند الفتح لأول مرة
    updateHistoryList();
  </script>
</body>
</html>
