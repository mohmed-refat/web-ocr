<script>
  const imageInput = document.getElementById('imageInput');
  const outputDiv = document.getElementById('output');
  const aiResultDiv = document.getElementById('aiResult');
  const loading = document.getElementById('loading');

  imageInput.addEventListener('change', () => {
    const file = imageInput.files[0];
    if (!file) return;

    loading.style.display = 'block';
    outputDiv.textContent = '';
    aiResultDiv.textContent = '';
    aiResultDiv.className = '';

    Tesseract.recognize(
      file,
      'ara+eng',
      { logger: m => console.log(m) }
    ).then(({ data: { text } }) => {
      loading.style.display = 'none';
      const cleanedText = text.trim();
      outputDiv.textContent = cleanedText || 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø£ÙŠ Ù†Øµ.';

      // ðŸ§  Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ (Reinforcement AI)
      storeInHistory(cleanedText);

      // ðŸ¤– ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ
      const decision = analyzeText(cleanedText);
      aiResultDiv.textContent = decision.message;
      aiResultDiv.className = decision.level;
    }).catch(err => {
      loading.style.display = 'none';
      outputDiv.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„: ' + err.message;
    });
  });

  // ðŸ§  Decision AI
  function analyzeText(text) {
    const lower = text.toLowerCase();
    const history = getHistory();

    // ØªØ­Ù„ÙŠÙ„ Crash
    if (lower.includes("crash") || lower.includes("x")) {
      let crashValues = lower.match(/([0-9]+\.[0-9]+)x/g) || [];
      let avg = crashValues.map(v => parseFloat(v)).reduce((a,b) => a + b, 0) / (crashValues.length || 1);

      if (avg < 1.5) {
        return { message: "ðŸ“‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„: Ù…Ø¹Ø¯Ù„ Ù…Ù†Ø®ÙØ¶ - ØªØ¬Ù†Ø¨ Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø¢Ù†.", level: "danger" };
      } else if (avg < 3.0) {
        return { message: "ðŸ“ˆ Ø§Ù„ØªØ­Ù„ÙŠÙ„: Ù…ØªÙˆØ³Ø· - ØªØ§Ø¨Ø¹ Ø§Ù„Ø­Ø°Ø±.", level: "warning" };
      } else {
        return { message: "ðŸš€ Ø§Ù„ØªØ­Ù„ÙŠÙ„: Ù…Ø¹Ø¯Ù„ Ø¹Ø§Ù„ÙŠ! Ø±Ø§Ù‚Ø¨ Ø§Ù„ÙØ±ØµØ© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.", level: "success" };
      }
    }

    // ØªØ­Ù„ÙŠÙ„ Mines
    if (lower.includes("mines") || lower.includes("bomb") || lower.includes("ðŸ’£")) {
      return { message: "ðŸ’£ ØªÙ… Ø§Ù„ÙƒØ´Ù Ø¹Ù† Ù„Ø¹Ø¨Ø© Mines. Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¹Ù„Ù‘Ù… Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬...", level: "warning" };
    }

    // ØªØ­Ù„ÙŠÙ„ Ø¹Ø§Ù…
    if (lower.length < 10) {
      return { message: "ðŸ“­ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ Ù…ÙÙ‡ÙˆÙ…Ø©. Ø­Ø§ÙˆÙ„ Ø¨ØµÙˆØ±Ø© Ø£ÙˆØ¶Ø­.", level: "danger" };
    }

    return { message: "ðŸ”„ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ¹Ù„Ù… Ù…Ù† Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯...", level: "warning" };
  }

  // ðŸ§  ØªØ®Ø²ÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ø­Ù„ÙŠÙ‹Ø§ (Reinforcement AI)
  function storeInHistory(newText) {
    const history = getHistory();
    history.push({ text: newText, timestamp: new Date().toISOString() });
    localStorage.setItem('ocr_history', JSON.stringify(history.slice(-50))); // Ø­ÙØ¸ Ø¢Ø®Ø± 50 ÙÙ‚Ø·
  }

  function getHistory() {
    return JSON.parse(localStorage.getItem('ocr_history') || '[]');
  }
</script>
