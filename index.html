<script>
  const imageInput = document.getElementById('imageInput');
  const outputDiv = document.getElementById('output');
  const aiResultDiv = document.getElementById('aiResult');
  const loading = document.getElementById('loading');

  imageInput.addEventListener('change', () => {
    const file = imageInput.files[0];
    if (!file) return;

    loading.style.display = 'block';
    outputDiv.textContent = '';
    aiResultDiv.textContent = '';
    aiResultDiv.className = '';

    Tesseract.recognize(
      file,
      'ara+eng',
      { logger: m => console.log(m) }
    ).then(({ data: { text } }) => {
      loading.style.display = 'none';
      const cleanedText = text.trim();
      outputDiv.textContent = cleanedText || 'لم يتم التعرف على أي نص.';

      // 🧠 حفظ النتيجة في التخزين المحلي (Reinforcement AI)
      storeInHistory(cleanedText);

      // 🤖 تحليل النص
      const decision = analyzeText(cleanedText);
      aiResultDiv.textContent = decision.message;
      aiResultDiv.className = decision.level;
    }).catch(err => {
      loading.style.display = 'none';
      outputDiv.textContent = 'حدث خطأ أثناء التحليل: ' + err.message;
    });
  });

  // 🧠 Decision AI
  function analyzeText(text) {
    const lower = text.toLowerCase();
    const history = getHistory();

    // تحليل Crash
    if (lower.includes("crash") || lower.includes("x")) {
      let crashValues = lower.match(/([0-9]+\.[0-9]+)x/g) || [];
      let avg = crashValues.map(v => parseFloat(v)).reduce((a,b) => a + b, 0) / (crashValues.length || 1);

      if (avg < 1.5) {
        return { message: "📉 التحليل: معدل منخفض - تجنب اللعب الآن.", level: "danger" };
      } else if (avg < 3.0) {
        return { message: "📈 التحليل: متوسط - تابع الحذر.", level: "warning" };
      } else {
        return { message: "🚀 التحليل: معدل عالي! راقب الفرصة القادمة.", level: "success" };
      }
    }

    // تحليل Mines
    if (lower.includes("mines") || lower.includes("bomb") || lower.includes("💣")) {
      return { message: "💣 تم الكشف عن لعبة Mines. جاري التعلّم من النتائج...", level: "warning" };
    }

    // تحليل عام
    if (lower.length < 10) {
      return { message: "📭 لم يتم التعرف على نتائج مفهومة. حاول بصورة أوضح.", level: "danger" };
    }

    return { message: "🔄 جارٍ التعلم من النمط الجديد...", level: "warning" };
  }

  // 🧠 تخزين التاريخ محليًا (Reinforcement AI)
  function storeInHistory(newText) {
    const history = getHistory();
    history.push({ text: newText, timestamp: new Date().toISOString() });
    localStorage.setItem('ocr_history', JSON.stringify(history.slice(-50))); // حفظ آخر 50 فقط
  }

  function getHistory() {
    return JSON.parse(localStorage.getItem('ocr_history') || '[]');
  }
</script>
